# CLAUDE_CODE_USAGE_GUIDE.md - 与Claude Code协作规则与最佳实践

为了提高与Claude Code的协作效率，并避免 Agent（斯嘉丽）过度“微管理”，特制定以下规则和最佳实践。

**职责边界**：`coding-agent`（Claude Code）仅负责**代码相关任务**（编写/修改/调试/审查代码）。纯文档内容修改（如仅改 README、说明文字）不通过 Claude Code，按文档规范由本 Agent 读-改-写或另行处理。

## 核心协作原则

1.  **高层次指令优先：** 始终尝试使用自然语言，以“做什么”为核心向Claude Code提出需求，而不是“怎么做”或提供详细的代码实现。
2.  **信任其实现能力：** 信任Claude Code能够根据高层次指令自主地实现代码逻辑，包括选择合适的方法、变量命名、代码结构等。
3.  **明确目标与上下文：** 在提出需求时，明确告知Claude Code当前的任务目标、涉及的文件、以及预期的输出或效果。
4.  **提供必要约束：** 如果有特定的库、函数或实现模式是必须遵守的，以简洁的语言明确指出，而不是提供完整的代码。
5.  **结果导向：** 专注于验证Claude Code的输出是否符合预期，而不是纠结于其实现细节。如果结果不符，再提供更具体的反馈。
6.  **避免重复劳动：** 除非明确要求，否则不应重复提供已被Claude Code接受或处理过的信息。

## 通过 `sessions_spawn` 调用 `coding-agent`（Claude Code）的最佳实践

当我（Agent（斯嘉丽））需要 Claude Code 来完成代码任务时，使用 **`sessions_spawn`** 启动会话，并遵循以下流程：

### 0. 任务分解

-   **利用 `task-decomposer` 技能（若已配置）**：在将任务交给 Claude Code 之前，对复杂的编码任务可先利用 `task-decomposer` 技能进行详细分解。
    -   **目的**：将大型、模糊的开发任务拆解为一系列清晰、可执行的子任务，明确每个子任务的目标、输入、输出和依赖关系。
    -   **益处**：确保 Claude Code 每次处理的任务范围明确，提高代码生成的准确性和效率，便于进度跟踪和问题排查。
    -   **若本环境未配置该技能**：可跳过，在交付时注明未做正式分解及采用的替代做法（如人工拆解为 checklist）。

### 1. 任务准备

-   **创建独立工作目录**：为每个 Claude Code 任务创建独立目录，确保环境隔离和文件管理清晰。工作目录可在 `workdir` 中指定。
-   **需求文档就位**：将需求文档放在 `coding-agent` 可访问的路径内（见下文「文件与目录管理规范」），且**不得**将完整需求内容直接粘贴到 `task` 参数中。

### 2. 启动与指令下达（使用 `sessions_spawn`）

-   **日志与可追踪性（强制）**：所有由 Claude Code 实现的代码须具备**详细日志**，关键流程、关键决策与异常可通过日志追踪。**制定需求文档时必须在文档或传给 Claude Code 的 task 中明确要求**：“开发过程中添加详细日志，关键步骤与异常可通过日志追踪。”
-   **通过 `sessions_spawn` 启动 `coding-agent`**：
    -   在 `sessions_spawn` 的 **`task`** 参数中，**只提供需求文档的文件路径与明确读取指令**，例如：“请自行读取 `<workdir>/REQUIREMENTS.md`，并按其中要求实现功能，**开发过程中添加详细日志、支持通过日志追踪**，完成后运行测试。”
    -   **禁止**将完整需求文档内容直接作为 `task` 参数传入（除非需求极短且无文件存储必要）。
    -   通过 `workdir`（或等价参数）指定 Claude Code 的工作目录，确保需求文件位于该目录或可访问路径下。

### 3. 实时监控与交互

-   **监控会话输出**：在 `coding-agent` 启动后，通过平台提供的会话监控接口（如传入对应 `sessionId` 的 log/输出接口）实时获取其思考过程、建议和代码输出，以便及时判断和响应。
-   **交互式确认与免确认原则**：
    -   **常规操作**：当 Claude Code 询问是否执行某操作（如创建文件、接受修改）并给出数字选项（如 `1. Yes`, `2. No`）时，除非用户明确指示需要确认，否则 Agent（斯嘉丽）不再向用户二次确认，可直接向 Claude Code 发送确认指令（如 `1`），并全程监控，只向用户汇报阶段性进展和最终结果，或在遇到异常/无法自主决策时寻求指示。
    -   **例外（必须请示用户）**：涉及**不可逆或高风险操作**（与 AGENTS 一致：删库、删关键文件、覆盖生产数据、真实资金操作、对外发布、影响线上稳定性等）时，**不得**仅对 Claude Code 发确认，须先向用户确认后再决定是否执行。

### 4. 代码审查与优化（集成 `requesting-code-review` 技能，若已配置）

-   **主动代码审查**：在 Claude Code 完成代码编写或修改后，若本环境已配置 **`requesting-code-review`** 技能，应主动触发该技能。
    -   **触发时机**：完成主要任务、实现核心功能，或代码即将合并到主分支之前。
    -   **目的**：从外部视角验证代码质量、逻辑、规范性和是否符合要求。
    -   **流程**：向 `requesting-code-review` 提供 Claude Code 编写的代码及任务上下文，根据审查结果决定直接接受或将审查意见反馈给 Claude Code 迭代。
    -   **若本环境未配置该技能**：可跳过，在交付时注明未做正式代码审查及采用的替代做法（如人工 review 或测试覆盖）。

### 5. 任务收尾与强制验证

-   **强制验证文件创建/修改**：所有由 `coding-agent` 完成的文件创建或修改任务，我必须要求其在完成后，**通过 `ls -F <完整绝对路径>` 或 `cat <完整绝对路径>` 命令，验证文件确实已在要求路径下创建或修改，并输出验证结果**。
-   **文件获取与汇报**：在 Claude Code 完成所有操作并退出会话后，在指定工作目录中验证并获取最终生成或修改的文件，并按 AGENTS 规定的汇报格式向用户汇报（本步做了什么、结果与状态、下一步）。

### 6. 测试阶段的协作（日志定位 → 加日志 / 修复）

测试工作闭环以 **MEMORY.md「测试工作闭环」** 为准；与 Claude Code 的协作要点如下：

-   **优先从日志定位**：测试失败时，先根据现有日志定位错误；若无法定位，则进入“加日志”流程。
-   **加日志需求**：编写需求文档（或明确 task），要求 Claude Code 在**无法定位问题的相关代码路径**添加或增强详细日志（关键分支、入参/出参、异常栈等），并注明“完成后需重新执行测试以便通过日志定位问题”。通过 `sessions_spawn` 下达该需求，待其完成后**重新执行测试**，再根据新日志定位。
-   **修复需求**：定位到根因后，生成修复需求（问题描述、根因、期望行为、涉及文件/接口），通过 `sessions_spawn` 交给 Claude Code 修改；修改后**重新执行测试**。若仍未通过，则重复“从日志定位（必要时先加日志）→ 修复需求 → 修改 → 再测试”，直至测试通过。

## 文件与目录管理规范

**workspace 绝对路径**：`/Users/fengxiao/.openclaw/workspace`。

-   **日常测试或临时脚本**：统一存放在 `/Users/fengxiao/.openclaw/workspace/script/` 目录下。
-   **临时脚本的需求文档**：存放在 `/Users/fengxiao/.openclaw/workspace/script/requirement/` 目录下。
-   **具体项目的需求文档**：在该项目自己的根目录下创建 `requirement` 文件（或目录）管理。例如，`your_project_directory/REQUIREMENTS.md` 或 `your_project_directory/docs/spec.md`。

Agent（斯嘉丽）在将任务分配给 Claude Code 时，会确保需求文件位于 `coding-agent` `workdir` 的可访问路径内，并在 `sessions_spawn` 的 `task` 参数中明确指示其先读取该需求文件再进行开发。

## Agent 与 Claude Code 协作的沟通红线

1.  **需求传递规范：**
    *   **禁止直接粘贴需求内容：** 除非需求内容极短且无文件存储必要，否则一律禁止将完整的需求文档内容直接作为 `sessions_spawn` 的 `task` 参数。
    *   **强制文件路径引用：** 启动 `coding-agent` 时，必须通过 `sessions_spawn` 的 `task` 参数，明确告知 `coding-agent` 需求文档的文件路径，并指示它自行读取。
    *   **明确读取指令：** 在 `task` 参数中，除了提供文件路径，还需包含明确指令，例如“请自行读取该文件”，以确保 `coding-agent` 知道要从文件中获取需求。
    *   **强制日志要求：** 制定需求文档或下达 task 时**必须**要求 Claude Code 在开发过程中添加**详细日志**，关键步骤与异常可通过日志追踪；需求文档中应写明该要求，或在 task 指令中显式包含“添加详细日志、支持通过日志追踪”。

2.  **模型与思考模式：**
    *   **默认模型优先：** 除非用户明确指定，否则 `coding-agent` 应使用其默认模型进行开发。
    *   **思考模式按需开启：** 根据用户指令，灵活控制 `coding-agent` 的 `thinking` 模式（`on` 或 `off`），以便用户实时监控或减少输出干扰。

3.  **任务反馈机制：**
    *   `coding-agent` 完成任务后，应总结其工作成果和代码提交情况，并返回给主会话；本 Agent 按 AGENTS 规定的格式向用户汇报。

4.  **强制验证文件创建/修改**：所有由 `coding-agent` 完成的文件创建或修改任务，我必须要求其在完成后，**通过 `ls -F <完整绝对路径>` 或 `cat <完整绝对路径>` 命令，验证文件确实已在要求路径下创建或修改，并输出验证结果**。

---
*上次更新时间：2026-02-16*
